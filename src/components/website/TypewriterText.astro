---
type Props = {
  texts: string[];
  period?: number;
  cursorColor?: string;
  loop?: boolean;
};

const {texts, period = 200, cursorColor = '#fff', loop = false} = Astro.props;
---

<typewriter-text
  data-period={period}
  data-texts={texts}
  data-loop={loop ? 'true' : 'false'}
>
</typewriter-text>

<script>
  // Inspired on https://css-tricks.com/snippets/css/typewriter-effect/
  class TypewriterText extends HTMLElement {
    private loopNum: number = 0;
    private toRotate: string[] = [];
    private currentTxt: string = '';
    private isDeleting: boolean = false;
    private loop: boolean = false;
    private period: number = 200;

    constructor() {
      super();

      const period = parseInt(this.dataset.period ?? 'NaN');
      this.period = isNaN(period) ? 200 : period;

      this.toRotate = (this.dataset.texts ?? '').split(',');
      this.loop = this.dataset.loop === 'true';

      this.tick();
    }

    public tick(): void {
      const i = this.loopNum % this.toRotate.length;
      const fullTxt = this.toRotate[i];

      if (this.isDeleting) {
        this.currentTxt = fullTxt.substring(0, this.currentTxt.length - 1);
      } else {
        this.currentTxt = fullTxt.substring(0, this.currentTxt.length + 1);
      }

      this.textContent = this.currentTxt;

      let delta = this.period - Math.random() * 100;

      // Deletion speed is usually faster so we imitate it
      if (this.isDeleting) {
        delta /= 2;
      }

      // Stop if we shouldn't loop and we have shown all the texts
      if (
        this.currentTxt === this.toRotate[this.toRotate.length - 1] &&
        !this.loop
      ) {
        return;
      }

      if (!this.isDeleting && this.currentTxt === fullTxt) {
        delta = this.period;
        this.isDeleting = true;
      } else if (this.isDeleting && this.currentTxt === '') {
        this.isDeleting = false;
        this.loopNum++;
        delta = 500;
      }

      setTimeout(() => {
        this.tick();
      }, delta);
    }
  }

  customElements.define('typewriter-text', TypewriterText);
</script>

<style define:vars={{cursorColor}}>
  typewriter-text {
    border-right: 0.08em solid var(--cursorColor);
  }
</style>
